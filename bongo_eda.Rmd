---
title: "HB1103 Bongo Data"
output: github_document
---


Libraries
```{r results='hide', message=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(stringr)

```

Reading in data.
```{r results='hide', message = FALSE, warning=FALSE}

dta_bg <- read_csv("bongo_20180604_edit.csv")

```

Showing all column names and checking date format.
```{r}
names(dta_bg)

```

And checking the data format.
```{r}
head(dta_bg$formated_event_date)
```

Initial cleaning.
```{r}
dta_bg <- dta_bg %>% 
  mutate(DT_UTC = mdy_hm(formated_event_date), tz = "UTC",
         Date = date(mdy_hm(formated_event_date))) %>%
  arrange(DT_UTC) %>% # to put in time-order
  mutate( leg = factor(case_when(Date <= ymd("2011-06-22") ~ 1,
                         Date >= ymd("2011-06-27") & Date <= ymd("2011-07-15") ~ 2,
                         Date >= ymd("2011-07-20") ~ 3)))

dta_bg %>%
  group_by(leg) %>%
  summarize(`Number of Stations per Leg` = n_distinct(station)) %>%
  ungroup()
```

Here I'm stripping the date from the datetime to look at how many stations were during certing times of the day. Not really sure it will work as is. 
```{r}
dta_bg %>%
  mutate(hr = hour(DT_UTC)) %>%
  group_by(station) %>%
  summarize(sta = first(station), hrstrt = first(hr)) %>%
  ggplot(aes(hrstrt)) + geom_histogram(binwidth = 1) +
  geom_vline(xintercept = c(10, 22)) +
  xlab("Bongo Start Hour UTC")

```



Reading in functional group data. I initally grouped the critters and Nadine checked them for me.
```{r}
fnct_grp <- read_csv("plankton_fnct_grp_from_Nadine.csv")
```

Joining the functional group file to the data file.
```{r}

dta_bg_jn <- dta_bg %>%  
  left_join(fnct_grp, by = "taxa_name")

dta_bg_jn %>% 
  group_by(functional_group) %>%
  summarise(cnt = n()) %>%
  ungroup()

```

Oops... where did the NAs come from? (Check the Next or '2' button if you don't see the NAs)
```{r}
dta_bg_jn %>%
  filter(is.na(functional_group)) %>%
  select(taxa_name, event_number)
```

Well, at least they are all the same taxa name.

Fixing the NAs in the taxa name.
```{r}
dta_bg_jn <- dta_bg_jn %>%
  mutate(functional_group = ifelse(taxa_name == 'Paguridea', 'OIT', functional_group))

dta_bg_jn %>%
  group_by(functional_group) %>%
  summarise(cnt = n()) %>%
  ungroup()
```

Time for a little ArcGIS to determine transects and when EK60 data were collected (daytime). Going to group by station and export.

```{r results='hide', message=FALSE, warning=FALSE}
library(sp)
library(rgdal)
```

```{r}
bg_stn <- dta_bg %>%
  select(leg, station, DT_UTC, latitude, longitude) %>%
  group_by(station) %>%
  summarize(leg = first(leg), DT = first(DT_UTC), lat = first(latitude), lon = first(longitude))

bg_stn %>% ggplot(aes(lon, lat, color = leg) ) +
  geom_point()
```

```{r}
#turn time into a character column to bring into ArcGIS.
bg_stn_df <- bg_stn %>%
  mutate(DT_UTC = as.character(DT)) %>%
  select(DT_UTC, leg, station, lat, lon)
  data.frame()
  
head(bg_stn_df)

bg_coords <- cbind(bg_stn_df$lon, bg_stn_df$lat)     #creating coordinate list 
row.names(bg_coords) <- 1:nrow(bg_coords)               #adding index values to rows             
str(bg_coords)                                          #compact summary of object                 

head(bg_coords)

crs_var <- CRS("+proj=longlat +ellps=WGS84")                #adding WGS84 geoid, 'CRS' comes from sp or rgdal package
bg_sp <- SpatialPoints(bg_coords, proj4string = crs_var)    #turing CTD into SpatialPoints class object, S4
summary(bg_sp)

bbox(bg_sp)                              #returns bounding box
proj4string(bg_sp)                       #returns the projection and ellispoid


# turn the data into a spatial points data frame with data frame and coordinates list
bg_spdf <- SpatialPointsDataFrame(bg_coords, bg_stn_df, proj4string = crs_var, match.ID = TRUE)     
names(bg_spdf)


##### write spatial data frame to shapefile####
writeOGR(bg_spdf, "C://Users//ealab//Documents//ArcGIS//AMAPPS//shp_from_R", layer="XYbg_R_shp",driver="ESRI Shapefile", verbose=TRUE)

#Import the shapefile to file geodatabase, then convert DT from text to datetime using 'Convert Time Field'
```

summary(dta_bg$DT_UTC)

